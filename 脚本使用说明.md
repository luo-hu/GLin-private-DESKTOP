# 📜 脚本使用说明

本项目包含3个Shell脚本，用于简化编译和测试流程。

---

## 📁 脚本文件总览

| 脚本文件 | 主要作用 | 使用场景 | 推荐指数 |
|---------|---------|---------|---------|
| **build.sh** | 清理并重新构建项目 | 修改代码后需要完全重新编译 | ⭐⭐⭐⭐⭐ |
| **run_paper_test.sh** | 运行论文标准实验（交互式） | 正式运行实验，提供前台/后台选择 | ⭐⭐⭐⭐⭐ |
| **test_fix.sh** | 测试段错误修复是否有效 | 验证bug修复，后台自动监控 | ⭐⭐⭐ |

---

## 1️⃣ build.sh - 构建脚本

### 🎯 作用

完全清理并重新构建整个项目，确保编译环境干净。

### 📋 功能详解

```bash
#!/usr/bin/env bash

# 1. 强制清理旧的构建目录
rm -rf build

# 2. 清理根目录可能存在的污染缓存
rm -f CMakeCache.txt
rm -rf CMakeFiles/

# 3. 创建并进入 build 目录
mkdir -p build
cd build

# 4. 运行 cmake 配置
cmake -DCMAKE_BUILD_TYPE=Release \
      -DGEOS_INCLUDE_DIR=/usr/local/geos/include \
      -DGEOS_LIBRARY=/usr/local/geos/lib/libgeos.so \
      -DBoost_INCLUDE_DIR=/usr/local/include \
      -DBoost_LIBRARY_DIR=/usr/local/lib \
      ... # 其他配置

# 5. 编译
make

# 6. 返回根目录
cd ..

echo "构建成功！"
```

### 🚀 使用方法

```bash
# 在项目根目录运行
cd /home/lh/Software/GLin-private
./build.sh
```

### ✅ 何时使用

- ✅ 修改了源代码文件（`.cpp`, `.h`）
- ✅ 修改了CMakeLists.txt
- ✅ 编译出现奇怪错误（清理缓存）
- ✅ 切换了编译配置（Debug/Release）
- ✅ 更新了依赖库（GEOS、Boost）

### ⏱️ 预计时间

- 首次构建：1-3分钟
- 重新构建：30秒-1分钟

### 📊 输出示例

```
构建成功！
```

如果成功，您将在 `build/` 目录下看到可执行文件：
- `test_glin_paper_standard`
- `test_glin_hf`
- 等其他测试程序

---

## 2️⃣ run_paper_test.sh - 论文实验脚本

### 🎯 作用

运行完整的GLIN论文标准实验，支持前台或后台运行。

### 📋 功能详解

```bash
#!/bin/bash

# 显示实验配置信息
echo "配置信息："
echo "  - 数据量: 100,000个真实几何对象"
echo "  - 查询窗口: 每个选择性100个"
echo "  - 选择性级别: 0.1%, 1%, 5%, 10%"
echo "  - 测试方法: 原始GLIN, GLIN-HF, Lite-AMF"

# 检查可执行文件是否存在
if [ ! -f "./test_glin_paper_standard" ]; then
    echo "可执行文件不存在，开始编译..."
    make test_glin_paper_standard
fi

# 询问用户运行方式
echo "请选择运行方式："
echo "  1) 前台运行（直接显示输出）"
echo "  2) 后台运行（保存到results.log）"
echo "  3) 取消"
read -p "请选择 [1-3]: " choice

# 根据选择运行
case $choice in
    1) ./test_glin_paper_standard ;;
    2) nohup ./test_glin_paper_standard > results.log 2>&1 & ;;
    3) exit 0 ;;
esac
```

### 🚀 使用方法

```bash
# 在项目根目录运行
cd /home/lh/Software/GLin-private
./run_paper_test.sh

# 按提示选择运行方式
```

### ✅ 何时使用

- ✅ 运行完整的论文实验
- ✅ 需要生成论文数据和图表
- ✅ 对比不同方法的性能
- ✅ 验证修复后的稳定性

### ⏱️ 预计时间

- 数据加载：5-10分钟
- 索引构建：5-10分钟
- 查询测试：20-60分钟
- **总计**：30分钟 - 1.5小时

### 📊 输出示例

```
==================================================
  GLIN论文标准实验框架
==================================================

配置信息：
  - 数据量: 100,000个真实几何对象
  - 查询窗口: 每个选择性100个
  - 选择性级别: 0.1%, 1%, 5%, 10%
  - 测试方法: 原始GLIN, GLIN-HF, Lite-AMF

预计运行时间: 30分钟 - 2小时

请选择运行方式：
  1) 前台运行（直接显示输出）
  2) 后台运行（保存到results.log）
  3) 取消

请选择 [1-3]:
```

### 💡 运行方式选择建议

#### 选项1：前台运行
**优点**：
- ✅ 实时看到输出
- ✅ 可以立即看到错误
- ✅ 容易调试

**缺点**：
- ❌ 终端关闭后程序停止
- ❌ 需要保持终端打开
- ❌ SSH断开后程序停止

**适合场景**：
- 快速测试
- 调试程序
- 短时间运行

#### 选项2：后台运行（推荐用于长时间实验）
**优点**：
- ✅ 可以关闭终端
- ✅ SSH断开后继续运行
- ✅ 输出保存到文件
- ✅ 可以离开电脑

**缺点**：
- ❌ 看不到实时输出（需要用tail查看）

**适合场景**：
- 正式实验
- 长时间运行
- 需要离开电脑

### 📈 查看后台运行进度

如果选择后台运行，使用以下命令查看进度：

```bash
# 查看实时输出（最推荐）
tail -f build/results.log

# 查看测试进度
grep -E '(测试选择性|平均查询时间)' build/results.log | tail -20

# 查看最终结果
grep -A 50 '📊 GLIN论文标准实验结果' build/results.log

# 查看进程状态
ps aux | grep test_glin_paper_standard

# 终止程序（如果需要）
pkill -f test_glin_paper_standard
```

---

## 3️⃣ test_fix.sh - 修复验证脚本

### 🎯 作用

测试段错误修复是否有效，自动监控程序运行状态。

### 📋 功能详解

```bash
#!/bin/bash

echo "=================================================="
echo "  段错误修复验证测试"
echo "=================================================="

cd /home/lh/Software/GLin-private/build

# 清理旧的日志
rm -f results.log test_results_*.log

# 运行测试并捕获退出代码
nohup ./test_glin_paper_standard > test_results_full.log 2>&1 &
TEST_PID=$!

echo "✅ 测试进程已启动"
echo "   进程ID: $TEST_PID"
echo "   日志文件: test_results_full.log"

# 等待5秒，检查进程是否还在运行
sleep 5

if ps -p $TEST_PID > /dev/null; then
    echo "✅ 进程正在运行"
    echo ""
    echo "实时监控命令："
    echo "  tail -f test_results_full.log"
    echo ""
    echo "检查段错误："
    echo "  grep -i 'segmentation' test_results_full.log"
else
    echo "❌ 进程已退出（可能是段错误）"
    tail -50 test_results_full.log
    exit 1
fi
```

### 🚀 使用方法

```bash
# 在项目根目录运行
cd /home/lh/Software/GLin-private
./test_fix.sh
```

### ✅ 何时使用

- ✅ 修复段错误后，验证是否真正解决
- ✅ 快速检查程序是否能正常启动
- ✅ 自动后台运行并监控状态
- ✅ 调试内存问题

### ⏱️ 预计时间

- 启动检查：5秒
- 完整运行：30分钟 - 2小时

### 📊 输出示例

**成功情况**：
```
==================================================
  段错误修复验证测试
==================================================

🧪 开始测试修复后的程序...

✅ 测试进程已启动
   进程ID: 12345
   日志文件: test_results_full.log

⏳ 监控测试进程...

✅ 进程正在运行

实时监控命令：
  tail -f test_results_full.log

查看测试进度：
  grep -E '(测试选择性|生成.*查询窗口|平均查询时间)' test_results_full.log | tail -20

检查段错误：
  grep -i 'segmentation' test_results_full.log

终止测试：
  kill 12345

==================================================
  测试正在后台运行
  预计运行时间: 30分钟 - 2小时
==================================================
```

**失败情况**（段错误）：
```
==================================================
  段错误修复验证测试
==================================================

🧪 开始测试修复后的程序...

✅ 测试进程已启动
   进程ID: 12345
   日志文件: test_results_full.log

⏳ 监控测试进程...

❌ 进程已退出（可能是段错误）

查看错误：
（显示最后50行日志）
```

---

## 🔄 推荐使用流程

### 场景1：修改代码后运行实验

```bash
# 1. 重新编译
./build.sh

# 2. 运行实验
./run_paper_test.sh
# 选择 2（后台运行）

# 3. 查看实时进度
tail -f build/results.log

# 4. 查看最终结果
grep -A 50 '📊 GLIN论文标准实验结果' build/results.log
```

### 场景2：验证bug修复

```bash
# 1. 修改代码

# 2. 重新编译
./build.sh

# 3. 运行验证测试
./test_fix.sh

# 4. 监控运行（新终端）
cd /home/lh/Software/GLin-private/build
tail -f test_results_full.log

# 5. 检查是否有段错误
grep -i 'segmentation' test_results_full.log
```

### 场景3：快速测试

```bash
# 1. 编译（如果需要）
./build.sh

# 2. 前台运行（快速查看结果）
cd build
./test_glin_paper_standard
```

---

## 🛠️ 常见问题

### Q1: 为什么 `./build.sh` 运行失败？

**可能原因**：
1. 权限问题：`chmod +x build.sh`
2. 依赖库未安装（GEOS、Boost）
3. CMake版本过低

**解决方法**：
```bash
# 检查权限
ls -l build.sh

# 如果没有执行权限，添加
chmod +x build.sh

# 检查依赖库
ls /usr/local/geos/include
ls /usr/local/include/boost
```

### Q2: 后台运行如何停止程序？

```bash
# 方法1：使用进程ID
kill <PID>

# 方法2：查找并终止
pkill -f test_glin_paper_standard

# 方法3：强制终止
pkill -9 -f test_glin_paper_standard
```

### Q3: results.log 文件很大怎么办？

```bash
# 只查看最后100行
tail -100 results.log

# 只查看错误
grep -i error results.log

# 只查看结果表格
grep -A 50 '📊 GLIN论文标准实验结果' results.log

# 清理旧日志
rm results.log test_results_*.log
```

### Q4: 如何同时运行多个实验？

```bash
# 实验1：默认配置
cd build
nohup ./test_glin_paper_standard > exp1.log 2>&1 &

# 实验2：修改代码后（需要编译到不同目录）
cd build2
nohup ./test_glin_paper_standard > exp2.log 2>&1 &

# 查看所有运行的实验
ps aux | grep test_glin
```

---

## 📝 脚本对比总结

| 特性 | build.sh | run_paper_test.sh | test_fix.sh |
|------|----------|------------------|------------|
| **主要功能** | 编译项目 | 运行完整实验 | 验证bug修复 |
| **交互性** | 无 | 有（选择运行方式） | 无（自动后台） |
| **运行时间** | 1-3分钟 | 30分钟-2小时 | 30分钟-2小时 |
| **输出文件** | 无 | results.log | test_results_full.log |
| **适合场景** | 开发时编译 | 正式实验 | 调试验证 |
| **必须使用** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## 🎯 最佳实践

1. **修改代码后必须运行 `build.sh`**
2. **正式实验使用 `run_paper_test.sh`，选择后台运行**
3. **使用 `tail -f` 实时查看后台运行的日志**
4. **实验结束后检查 `results.log` 确认完整性**
5. **保存重要实验的日志文件（重命名）**

---

**文档创建日期**：2025-11-25
**最后更新**：2025-11-25
**适用版本**：所有版本
