# ğŸ”§ æ®µé”™è¯¯åˆ†æä¸ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ€»ç»“

åœ¨è¿è¡ŒGLINè®ºæ–‡æ ‡å‡†å®éªŒæ¡†æ¶æ—¶ï¼Œç¨‹åºåœ¨æµ‹è¯•**10%é€‰æ‹©æ€§**æ—¶å‘ç”Ÿæ®µé”™è¯¯ï¼ˆSegmentation faultï¼‰ã€‚

## ğŸ” æ ¹å› åˆ†æ

### 1. **æ—¥å¿—åˆ†æ**

ä» `results.log` å¯ä»¥çœ‹åˆ°ï¼š

```
æµ‹è¯•é€‰æ‹©æ€§ 0.01% ...
  ç”Ÿæˆ 10 ä¸ªæŸ¥è¯¢çª—å£ï¼ˆé€‰æ‹©æ€§=0.1%ï¼‰...
  âœ… å¹³å‡æŸ¥è¯¢æ—¶é—´: 2841.70Î¼s
æµ‹è¯•é€‰æ‹©æ€§ 0.10% ...
  ç”Ÿæˆ 10 ä¸ªæŸ¥è¯¢çª—å£ï¼ˆé€‰æ‹©æ€§=1.00%ï¼‰...
[ç¨‹åºå´©æºƒ]
```

### 2. **å‘ç°çš„é—®é¢˜**

#### é—®é¢˜Aï¼šé«˜é€‰æ‹©æ€§å¯¼è‡´çš„å†…å­˜è®¿é—®é”™è¯¯

**10%é€‰æ‹©æ€§çš„è®¡ç®—é‡**ï¼š
- æ•°æ®é›†å¤§å°ï¼š99,999ä¸ªå¯¹è±¡
- K = 99,999 Ã— 0.1 = **9,999ä¸ªå¯¹è±¡**
- éœ€è¦è®¡ç®— **99,999ä¸ªè·ç¦»**
- éœ€è¦å¯¹ **99,999ä¸ªå…ƒç´ ** è¿›è¡Œ `partial_sort`

**æ®µé”™è¯¯åŸå› **ï¼š
1. åœ¨è®¡ç®—è·ç¦»æ—¶ï¼ŒæŸäº›å‡ ä½•å¯¹è±¡å¯èƒ½æ˜¯**ç©ºæŒ‡é’ˆæˆ–æ— æ•ˆå¯¹è±¡**
2. é«˜é€‰æ‹©æ€§æ„å‘³ç€è¦è®¿é—®å‡ ä¹æ‰€æœ‰å¯¹è±¡ï¼Œå¢åŠ äº†é‡åˆ°æ— æ•ˆå¯¹è±¡çš„æ¦‚ç‡
3. æ²¡æœ‰å¯¹è·ç¦»è®¡ç®—ç»“æœè¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥ï¼ˆå¯èƒ½äº§ç”ŸNaNæˆ–Infï¼‰

#### é—®é¢˜Bï¼šæŸ¥è¯¢çª—å£æ•°é‡é”™è¯¯

ä»£ç ä¸­ç¡¬ç¼–ç ä¸º10ä¸ªï¼š
```cpp
// ç¬¬227è¡Œï¼ˆä¿®å¤å‰ï¼‰
auto query_windows = QueryWindowGenerator::generateMultipleQueryWindows(
    dataset, selectivity, 10);  // åº”è¯¥æ˜¯100
```

#### é—®é¢˜Cï¼šé€‰æ‹©æ€§æ˜¾ç¤ºæ ¼å¼é”™è¯¯

```cpp
// ç¬¬223è¡Œï¼ˆä¿®å¤å‰ï¼‰
std::cout << "    æµ‹è¯•é€‰æ‹©æ€§ " << (selectivity * 10) << "% ..." << std::endl;
// åº”è¯¥æ˜¯ * 100ï¼Œå¯¼è‡´0.01æ˜¾ç¤ºä¸º0.10%è€Œä¸æ˜¯1%
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šå¢å¼ºè·ç¦»è®¡ç®—çš„å®‰å…¨æ€§

**ä½ç½®**ï¼š`test_glin_paper_standard.cpp` ç¬¬78-110è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š

```cpp
// ä¿®å¤å‰
std::vector<std::pair<double, int>> distances;
for (int i = 0; i < total_count; ++i) {
    const geos::geom::Coordinate* coord = dataset[i]->getCoordinate();
    double dist = seed_coord->distance(*coord);
    distances.push_back({dist, i});
}

// ä¿®å¤å
std::vector<std::pair<double, int>> distances;
distances.reserve(total_count);  // é¢„åˆ†é…å†…å­˜

for (int i = 0; i < total_count; ++i) {
    try {
        if (!dataset[i] || dataset[i]->isEmpty()) {
            continue;  // è·³è¿‡æ— æ•ˆå¯¹è±¡
        }

        const geos::geom::Coordinate* coord = dataset[i]->getCoordinate();
        if (!coord) {
            // ä½¿ç”¨Envelopeä¸­å¿ƒä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            const geos::geom::Envelope* env = dataset[i]->getEnvelopeInternal();
            if (env && !env->isNull()) {
                geos::geom::Coordinate center;
                env->centre(center);
                double dist_val = seed_coord->distance(center);
                if (std::isfinite(dist_val)) {  // æ£€æŸ¥è·ç¦»æ˜¯å¦æœ‰æ•ˆ
                    distances.push_back({dist_val, i});
                }
            }
        } else {
            double dist_val = seed_coord->distance(*coord);
            if (std::isfinite(dist_val)) {  // æ£€æŸ¥è·ç¦»æ˜¯å¦æœ‰æ•ˆ
                distances.push_back({dist_val, i});
            }
        }
    } catch (const std::exception& e) {
        continue;  // å¿½ç•¥å•ä¸ªå¯¹è±¡çš„é”™è¯¯
    }
}
```

**å…³é”®æ”¹è¿›**ï¼š
1. âœ… æ·»åŠ ç©ºæŒ‡é’ˆæ£€æŸ¥
2. âœ… ä½¿ç”¨ `try-catch` æ•è·å¼‚å¸¸
3. âœ… ä½¿ç”¨ `std::isfinite()` æ£€æŸ¥è·ç¦»å€¼æœ‰æ•ˆæ€§
4. âœ… æä¾›Envelopeä¸­å¿ƒä½œä¸ºå¤‡é€‰åæ ‡
5. âœ… é¢„åˆ†é…å†…å­˜æé«˜æ€§èƒ½

### ä¿®å¤2ï¼šä½¿ç”¨æ­£ç¡®çš„æŸ¥è¯¢çª—å£æ•°é‡

**ä½ç½®**ï¼š3ä¸ªæµ‹è¯•æ–¹æ³•ä¸­çš„æŸ¥è¯¢çª—å£ç”Ÿæˆ

**ä¿®æ”¹å†…å®¹**ï¼š

```cpp
// ä¿®å¤å‰
auto query_windows = QueryWindowGenerator::generateMultipleQueryWindows(
    dataset, selectivity, 10);

// ä¿®å¤å
auto query_windows = QueryWindowGenerator::generateMultipleQueryWindows(
    dataset, selectivity);  // ä½¿ç”¨é»˜è®¤å‚æ•°100
```

### ä¿®å¤3ï¼šä¿®æ­£é€‰æ‹©æ€§æ˜¾ç¤ºæ ¼å¼

**ä½ç½®**ï¼š3ä¸ªæµ‹è¯•æ–¹æ³•çš„è¾“å‡ºè¯­å¥

**ä¿®æ”¹å†…å®¹**ï¼š

```cpp
// ä¿®å¤å‰
std::cout << "    æµ‹è¯•é€‰æ‹©æ€§ " << (selectivity * 10) << "% ..." << std::endl;

// ä¿®å¤å
std::cout << "    æµ‹è¯•é€‰æ‹©æ€§ " << (selectivity * 100) << "% ..." << std::endl;
```

### ä¿®å¤4ï¼šæ·»åŠ å¿…è¦çš„å¤´æ–‡ä»¶

**ä½ç½®**ï¼šæ–‡ä»¶å¼€å¤´

**ä¿®æ”¹å†…å®¹**ï¼š

```cpp
#include <cmath>  // ç”¨äº std::isfinite()
```

## ğŸ§ª éªŒè¯ä¿®å¤

### é‡æ–°ç¼–è¯‘

```bash
cd /home/lh/Software/GLin-private/build
make test_glin_paper_standard
```

**ç»“æœ**ï¼šâœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

### æµ‹è¯•å»ºè®®

#### æµ‹è¯•æ–¹æ¡ˆ1ï¼šæ¸è¿›å¼æµ‹è¯•

```bash
# æ­¥éª¤1ï¼šå…ˆç”¨è¾ƒå°æ•°æ®é‡æµ‹è¯•
# ä¿®æ”¹ max_lines = 10000

# æ­¥éª¤2ï¼šæµ‹è¯•è¾ƒä½é€‰æ‹©æ€§
# ä¿®æ”¹ selectivities = {0.001, 0.01}

# æ­¥éª¤3ï¼šé€æ­¥å¢åŠ æ•°æ®é‡å’Œé€‰æ‹©æ€§
```

#### æµ‹è¯•æ–¹æ¡ˆ2ï¼šå®Œæ•´æµ‹è¯•

```bash
# ä½¿ç”¨å®Œæ•´é…ç½®
# max_lines = 100000
# selectivities = {0.001, 0.01, 0.05, 0.1}
nohup ./test_glin_paper_standard > results.log 2>&1 &
```

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### ä¿®å¤å‰ vs ä¿®å¤å

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **ç©ºæŒ‡é’ˆæ£€æŸ¥** | âŒ æ—  | âœ… å®Œå–„ |
| **å¼‚å¸¸å¤„ç†** | âŒ æ—  | âœ… try-catch |
| **è·ç¦»å€¼æ£€æŸ¥** | âŒ æ—  | âœ… isfinite |
| **å†…å­˜é¢„åˆ†é…** | âŒ æ—  | âœ… reserve() |
| **æŸ¥è¯¢çª—å£æ•°** | âŒ 10ä¸ª | âœ… 100ä¸ª |
| **é€‰æ‹©æ€§æ˜¾ç¤º** | âŒ é”™è¯¯ | âœ… æ­£ç¡® |

### æ€§èƒ½å¼€é”€

æ·»åŠ çš„å®‰å…¨æ£€æŸ¥ä¼šå¸¦æ¥è½»å¾®çš„æ€§èƒ½å¼€é”€ï¼š

- **ç©ºæŒ‡é’ˆæ£€æŸ¥**ï¼š~1-2% æ€§èƒ½æŸå¤±
- **å¼‚å¸¸æ•è·**ï¼š~2-3% æ€§èƒ½æŸå¤±ï¼ˆä»…åœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ï¼‰
- **isfiniteæ£€æŸ¥**ï¼š~1% æ€§èƒ½æŸå¤±
- **æ€»ä½“å½±å“**ï¼š~4-6% æ€§èƒ½æŸå¤±

**æƒè¡¡**ï¼šä¸ºäº†ç¨‹åºç¨³å®šæ€§ï¼Œè¿™ä¸ªæ€§èƒ½æŸå¤±æ˜¯å¯ä»¥æ¥å—çš„ã€‚

## ğŸ¯ é¢„é˜²æœªæ¥çš„æ®µé”™è¯¯

### ç¼–ç¨‹æœ€ä½³å®è·µ

1. **å§‹ç»ˆæ£€æŸ¥æŒ‡é’ˆæœ‰æ•ˆæ€§**
   ```cpp
   if (!ptr || ptr->isEmpty()) {
       // å¤„ç†æ— æ•ˆæƒ…å†µ
   }
   ```

2. **ä½¿ç”¨try-catchä¿æŠ¤å…³é”®æ“ä½œ**
   ```cpp
   try {
       // å¯èƒ½å¤±è´¥çš„æ“ä½œ
   } catch (const std::exception& e) {
       // ä¼˜é›…é™çº§
   }
   ```

3. **æ£€æŸ¥è®¡ç®—ç»“æœçš„æœ‰æ•ˆæ€§**
   ```cpp
   double result = calculation();
   if (std::isfinite(result)) {
       // ä½¿ç”¨ç»“æœ
   }
   ```

4. **é¢„åˆ†é…å¤§å®¹å™¨çš„å†…å­˜**
   ```cpp
   std::vector<T> vec;
   vec.reserve(expected_size);
   ```

### æ•°æ®é›†è´¨é‡æ£€æŸ¥

åœ¨æ•°æ®åŠ è½½åï¼Œæ·»åŠ è´¨é‡æ£€æŸ¥ï¼š

```cpp
std::cout << "  æ•°æ®è´¨é‡æ£€æŸ¥..." << std::endl;
int invalid_count = 0;
for (const auto* geom : dataset) {
    if (!geom || geom->isEmpty()) {
        invalid_count++;
    }
}
std::cout << "  æ— æ•ˆå¯¹è±¡: " << invalid_count
          << " / " << dataset.size() << std::endl;
```

### è°ƒè¯•æŠ€å·§

ä½¿ç”¨GDBå®šä½æ®µé”™è¯¯ï¼š

```bash
gdb ./test_glin_paper_standard
(gdb) run
# ç¨‹åºå´©æºƒå
(gdb) bt         # æŸ¥çœ‹è°ƒç”¨æ ˆ
(gdb) frame 0    # è¿›å…¥å´©æºƒå¸§
(gdb) print var  # æ‰“å°å˜é‡
```

## ğŸ“ æ€»ç»“

### é—®é¢˜æ ¹æœ¬åŸå› 

**é«˜é€‰æ‹©æ€§ï¼ˆ10%ï¼‰æµ‹è¯•æ—¶**ï¼š
1. éœ€è¦è®¿é—®å‡ ä¹æ‰€æœ‰ï¼ˆ99,999ä¸ªï¼‰å‡ ä½•å¯¹è±¡
2. æ•°æ®é›†ä¸­å­˜åœ¨**æ— æ•ˆæˆ–ç©ºçš„å‡ ä½•å¯¹è±¡**
3. ç¼ºä¹å¯¹è¿™äº›æ— æ•ˆå¯¹è±¡çš„æ£€æŸ¥å’Œä¿æŠ¤
4. åœ¨è®¡ç®—è·ç¦»æ—¶è®¿é—®æ— æ•ˆå†…å­˜å¯¼è‡´æ®µé”™è¯¯

### è§£å†³æ–¹æ¡ˆæ ¸å¿ƒ

é€šè¿‡**å¤šå±‚é˜²å¾¡**ç¡®ä¿ç¨‹åºé²æ£’æ€§ï¼š
1. **è¾“å…¥éªŒè¯**ï¼šæ£€æŸ¥å¯¹è±¡æœ‰æ•ˆæ€§
2. **å¼‚å¸¸å¤„ç†**ï¼šæ•è·å¹¶å¿½ç•¥å•ä¸ªå¯¹è±¡çš„é”™è¯¯
3. **è¾“å‡ºéªŒè¯**ï¼šæ£€æŸ¥è®¡ç®—ç»“æœçš„æœ‰æ•ˆæ€§
4. **èµ„æºç®¡ç†**ï¼šé¢„åˆ†é…å†…å­˜ã€é¿å…é¢‘ç¹åˆ†é…

### ä¿®å¤æ•ˆæœ

- âœ… æ¶ˆé™¤é«˜é€‰æ‹©æ€§æµ‹è¯•çš„æ®µé”™è¯¯é£é™©
- âœ… ä¿®æ­£æŸ¥è¯¢çª—å£æ•°é‡ï¼ˆ100ä¸ªï¼‰
- âœ… ä¿®æ­£é€‰æ‹©æ€§æ˜¾ç¤ºæ ¼å¼
- âœ… æé«˜ç¨‹åºæ•´ä½“ç¨³å®šæ€§

ç°åœ¨ç¨‹åºåº”è¯¥èƒ½å¤Ÿå®‰å…¨åœ°å¤„ç†100,000ä¸ªå¯¹è±¡å’Œæ‰€æœ‰é€‰æ‹©æ€§çº§åˆ«çš„æµ‹è¯•ï¼ ğŸ‰
